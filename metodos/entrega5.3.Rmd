---
title: "Entrega 5.3"
author: "Olszevicki Santiago"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
library(kableExtra)
library(dplyr)

```

# Código para reproducir los resultados:
```{r include=T, warning=FALSE}
estimar_p_intervalo <- function(nivel, datos){
  p.obs <- mean(datos)
  n <- length(datos)
  z <- qnorm((1-nivel)/2)
  left <- p.obs - z*sqrt(p.obs*(1-p.obs)/n)
  right <- p.obs + z*sqrt(p.obs*(1-p.obs)/n)
  return(c(left,right))
}

estimar_p_intervalo_alt <- function(nivel, datos){
  sum_xi.obs <- sum(datos)
  n <- length(datos)
  prp.out <- prop.test(x=sum_xi.obs, n=n, conf.level=nivel, correct=F)
  return(c(prp.out$conf.int[1],prp.out$conf.int[2]))
}


hallar_n_p <- function(nivel, L){
  z <- qnorm((1-nivel)/2)
  return(ceiling((2*sqrt(0.5*(1-0.5))*z/L)**2))
}

calcular_cubrimiento_longitud_empirico <- function(p, nivel, n, Nrep, seed, metodo = estimar_p_intervalo){
  set.seed(seed)
  cubre <- 0
  longs <- numeric(Nrep)
  for (x in 1:Nrep){
  datos <- rbinom(n = n, size = 1, prob = p)
  ci <- metodo(nivel, datos)
  cubre <- cubre + (p > min(ci) & p<max(ci))
  longs[x] <- max(ci)-min(ci)
  }
  c(cubre/Nrep, mean(longs))
  }

# Función principal para armar las dos tablas
generar_tablas_cubrimiento_longitud <- function(p_vals, n_vals, nivel = 0.95, Nrep = 1000, seed = 5,
                                                metodo = estimar_p_intervalo_alt) {
  cobertura_mat <- matrix(NA, nrow = length(p_vals), ncol = length(n_vals))
  longitud_mat <- matrix(NA, nrow = length(p_vals), ncol = length(n_vals))
  
  rownames(cobertura_mat) <- paste0("p=", p_vals)
  colnames(cobertura_mat) <- paste0("n=", n_vals)
  rownames(longitud_mat) <- paste0("p=", p_vals)
  colnames(longitud_mat) <- paste0("n=", n_vals)
  
  for (i in seq_along(p_vals)) {
    for (j in seq_along(n_vals)) {
      resultado <- calcular_cubrimiento_longitud_empirico(
        p = p_vals[i], nivel = nivel, n = n_vals[j],
        Nrep = Nrep, seed = seed, metodo = metodo
      )
      cobertura_mat[i, j] <- resultado[1]
      longitud_mat[i, j] <- resultado[2]
    }
  }
  
  list(cobertura = cobertura_mat, longitud = longitud_mat)
}

combinar_tablas_cubrimiento_longitud <- function(cobertura_mat, longitud_mat, digits = 3) {
  tabla_combinada <- matrix("", nrow = nrow(cobertura_mat), ncol = ncol(cobertura_mat))
  for (i in seq_len(nrow(cobertura_mat))) {
    for (j in seq_len(ncol(cobertura_mat))) {
      cobertura <- round(cobertura_mat[i, j], digits)
      longitud <- round(longitud_mat[i, j], digits)
      tabla_combinada[i, j] <- paste0(cobertura, " (", longitud, ")")
    }
  }
  rownames(tabla_combinada) <- rownames(cobertura_mat)
  colnames(tabla_combinada) <- colnames(cobertura_mat)
  return(tabla_combinada)
}

tablas<- generar_tablas_cubrimiento_longitud(p_vals = c(0.1,0.5),
                                                  n_vals = c(5,10,30,50,100,1000),
                                                  nivel = 0.95, 
                                                  Nrep = 1000, 
                                                  seed = 5,
                                                  metodo = estimar_p_intervalo)

tablas_alt <- generar_tablas_cubrimiento_longitud(p_vals = c(0.1,0.5),
                                                n_vals = c(5,10,30,50,100,1000),
                                                nivel = 0.95, 
                                                Nrep = 1000, 
                                                seed = 5,
                                                metodo = estimar_p_intervalo_alt) 

t1 <- combinar_tablas_cubrimiento_longitud(tablas$cobertura, tablas$longitud)
t2 <- combinar_tablas_cubrimiento_longitud(tablas_alt$cobertura, tablas_alt$longitud)
```

# Resultados finales
```{r}
kable(t1, caption = "Cobertura y longitud - Método 1", booktabs = TRUE) %>%
  kable_styling(full_width = FALSE, position = "center")

kable(t2, caption = "Cobertura y longitud - Método 2", booktabs = TRUE) %>%
  kable_styling(full_width = FALSE, position = "center")
```

# Comentario
En primer lugar, observamos valores altamente concordantes entre ambas estrategias para tamaños de muestra grandes ($n \geq 50$). De ello se deduce que las diferencias en la tasa de convergencia de cada uno de los pivotes a la normalidad resultan imperceptibles en dichos tamaños. Sin embargo, se aprecia que el primer método —aquel cuyo pivote utiliza una estimación de la varianza basada en la proporción observada (que, mediante el Teorema de Slutsky, verifica su normalidad asintótica)— presenta peores resultados para tamaños de muestra pequeños y para $p=0.1$. En estos casos, evidencia coberturas empíricas por debajo del 80% cuando $n \leq 30$. Este fenómeno es menos notorio en $p=0.5$, donde ambos métodos muestran un desempeño similar, aunque en esta simulación el método alternativo parece ofrecer intervalos ligeramente más cortos a igualdad de cobertura empírica.
